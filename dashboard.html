<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>

  <!-- Navbar -->
  <nav>
    <a href="profile.html">Profile</a>
    <a href="/logout">Logout</a>
  </nav>

  <!-- Header -->
  <div class="header" id="header">
    <h1>Welcome Back!</h1>
    <p>Your personalized fitness & diet plan is ready üöÄ</p>
  </div>

  <!-- Layout -->
  <div class="main-layout">
    <!-- Loading screen -->
    <div id="loading" class="loading-screen">
      <div class="spinner"></div>
      <p>Generating your personalized plan...</p>
    </div>

    <div class="content">
      <h2  style="color: #6aa6ff;">Here‚Äôs Your Plan</h2>

      <!-- Food Section -->
      <div class="section-container food-section">
        <h3>üçé Recommended Food</h3>
        <div id="food" class="items"></div>
      </div>

      <!-- Workout Section -->
      <div class="section-container workout-section">
        <h3>üèãÔ∏è Recommended Workouts</h3>
        <div id="workout" class="items"></div>
      </div>
    </div>

    <div class="profile-box" id="profileBox"></div>
  </div>

  <!-- Chat button -->
  <div id="chatButton" class="chat-button">üí¨</div>

  <!-- Chatbot -->
  <div class="chatbot" id="chatbot">
    <div class="chat-header">
      üí¨ Fitness Assistant
      <span id="closeChat">‚úñ</span>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type your message...">
      <button id="sendBtn">Send</button>
    </div>
  </div>

<script>
  // BMI Calculation
  function calculateBMI(weight, height) {
    height = height / 100;
    return (weight / (height * height)).toFixed(1);
  }

  // Render Food/Workout Cards
  function renderItems(containerId, items) {
    const container = document.getElementById(containerId);
    container.innerHTML = items.map(i => `
      <div class="plan-card">
        <img src="${i.img}" alt="${i.name}">
        <div class="text">
          <h4>${i.name}</h4>
          <p>${i.description || "No description available"}</p>
        </div>
      </div>
    `).join("");
  }

  // Load Profile & Plan
  async function loadProfile() {
    try {
      const resProfile = await fetch('/api/profile');
      const user = await resProfile.json();
      const bmi = calculateBMI(user.weight, user.height);

      // ‚úÖ Adjusted request (works with new /chat output)
      const resPlan = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: "Generate plan", type: "plan" })
      });
      const data = await resPlan.json();

      const plan = data.plan || { food: [], workout: [] };

      // Render cards
      renderItems("food", plan.food);
      renderItems("workout", plan.workout);

      // Profile box
      document.getElementById("profileBox").innerHTML = `
        <img src="${user.profile_pic || 'https://via.placeholder.com/150'}" alt="Profile">
        <h3>${user.name}</h3>
        <p>Age: ${user.age}</p>
        <p>Gender: ${user.gender}</p>
        <p>Height: ${user.height} cm</p>
        <p>Weight: ${user.weight} kg</p>
        <p>Goal: ${user.goal}</p>
        <p><strong>BMI: ${bmi}</strong></p>
      `;

      // Header update
      document.getElementById("header").innerHTML = `
        <h1>Welcome Back, ${user.name}!</h1>
        <p>Stay consistent üí™ ‚Äî your personalized fitness & diet plan is ready üöÄ</p>
      `;

      document.getElementById("loading").style.display = "none";
    } catch (err) {
      console.error(err);
      document.getElementById("loading").innerHTML = "<p>‚ö†Ô∏è Failed to load plan. Please try again.</p>";
    }
  }

  // Chatbot logic
  const chatButton = document.getElementById("chatButton");
  const chatbot = document.getElementById("chatbot");
  const closeChat = document.getElementById("closeChat");
  const sendBtn = document.getElementById("sendBtn");
  const chatInput = document.getElementById("chatInput");
  const chatMessages = document.getElementById("chatMessages");

  // Open/close chatbot
  chatButton.addEventListener("click", () => chatbot.style.display = "flex");
  closeChat.addEventListener("click", () => chatbot.style.display = "none");

  sendBtn.addEventListener("click", sendMessage);
  chatInput.addEventListener("keypress", (e) => { if (e.key === "Enter") sendMessage(); });

  async function sendMessage() {
    const msg = chatInput.value.trim();
    if (!msg) return;

    const userDiv = document.createElement("div");
    userDiv.className = "user-msg";
    userDiv.textContent = msg;
    chatMessages.appendChild(userDiv);
    chatInput.value = "";
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ prompt: msg, type: "plan" })
      });

      const data = await res.json();
      let botReply = data.reply || "I couldn‚Äôt process that.";

      if (data.plan) {
        botReply += "\n\nüçé A new plan has also been generated! (Check dashboard)";
      }

      const botDiv = document.createElement("div");
      botDiv.className = "bot-msg";
      botDiv.textContent = botReply;
      chatMessages.appendChild(botDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // ‚úÖ Update plan instantly if Gemini returned one
      if (data.plan) {
        renderItems("food", data.plan.food);
        renderItems("workout", data.plan.workout);
      }

    } catch (err) {
      console.error(err);
      const botDiv = document.createElement("div");
      botDiv.className = "bot-msg";
      botDiv.textContent = "‚ö†Ô∏è Error connecting to Gemini.";
      chatMessages.appendChild(botDiv);
    }
  }

  loadProfile();
</script>

</body>
</html>
